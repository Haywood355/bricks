<style>
  #corner {
    position: absolute;
    right: 1px;
    bottom: 2px;
    cursor: nwse-resize;
  }
</style>

<h2>Bricks Core Tester</h2>
<button id="create">Generate</button>
<div id="preview"></div>
<svg
  id="corner"
  width="16"
  height="16"
  viewBox="0 0 16 16"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path d="M16 0V16H0L16 0Z" fill="white" />
  <path d="M6.22577 16H3L16 3V6.22576L6.22577 16Z" fill="#8C8C8C" />
  <path d="M11.8602 16H8.63441L16 8.63441V11.8602L11.8602 16Z" fill="#8C8C8C" />
</svg>

<script>
  // notify plugin of button click
  document.getElementById("create").onclick = () => {
    parent.postMessage(
      { pluginMessage: { type: "generate-bricks-nodes" } },
      "*"
    );
  };

  // window resize logic
  const corner = document.getElementById("corner");
  function resizeWindow(e) {
    const size = {
      w: Math.max(50, Math.floor(e.clientX + 5)),
      h: Math.max(50, Math.floor(e.clientY + 5)),
    };
    parent.postMessage({ pluginMessage: { type: "resize", size: size } }, "*");
  }
  corner.onpointerdown = (e) => {
    corner.onpointermove = resizeWindow;
    corner.setPointerCapture(e.pointerId);
  };
  corner.onpointerup = (e) => {
    corner.onpointermove = null;
    corner.releasePointerCapture(e.pointerId);
  };

  // code preview logic
  window.addEventListener(
    "message",
    (event) => {
      const data = event.data.pluginMessage;

      if (data.type === "render-nodes") {
        const nodes = data.nodes;

        const outputDiv = document.getElementById("preview");
        outputDiv.innerHTML = "";
        nodes.forEach((node) => {
          outputDiv.appendChild(render(node));
        });
      }
    },
    false
  );

  function render(bricksNode) {
    const node = document.createElement(
      bricksNode.type === "element" ? bricksNode.tagName : "div"
    );

    if (bricksNode.type === "element") {
      // element node
      bricksNode.children.forEach((child) => {
        node.appendChild(render(child));
      });

      // image node
      if (bricksNode.base64image) {
        node.setAttribute(
          "src",
          `data:image/png;base64,${bricksNode.base64image}`
        );
      }
    } else if (bricksNode.type === "text") {
      const source = bricksNode.source;
      var newstyle = document.createElement("link"); // Create a new link Tag
      newstyle.setAttribute("rel", "stylesheet");
      newstyle.setAttribute("href", source); // Your .css File
      document.getElementsByTagName("head")[0].appendChild(newstyle);

      document.documentElement.style.setProperty(
        "--body-font",
        bricksNode.attributes["font-family"]
      );

      node.innerText = bricksNode.text;
    } else if (bricksNode.type === "svg") {
      // svg node
      node.innerHTML = bricksNode.svg;
    }

    if (Object.keys(bricksNode.attributes).length > 0) {
      node.style.cssText = Object.entries(bricksNode.attributes)
        .map(([key, value]) => `${key}:${value};`)
        .join("");
    }

    return node;
  }
</script>
